<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de Bord ‚Äî Admin CRS</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1A237E; --secondary: #0288D1; --accent: #7CB342;
      --danger: #e53935; --warning: #f57c00; --success: #388e3c;
      --white: #fff; --light: #F5F7FA; --border: #e8ecf4;
      --text: #1a1a2e; --text-light: #6b7a99;
      --sidebar-w: 260px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Open Sans', sans-serif; background: var(--light); color: var(--text); }
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0; width: var(--sidebar-w);
      background: linear-gradient(180deg, #0D1642 0%, #1A237E 100%);
      display: flex; flex-direction: column; z-index: 100; overflow-y: auto;
    }
    .sidebar-logo { padding: 28px 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .logo-row { display: flex; align-items: center; gap: 12px; }
    .logo-badge {
      width: 44px; height: 44px; border-radius: 12px;
      background: linear-gradient(135deg, var(--secondary), var(--accent));
      display: flex; align-items: center; justify-content: center;
      font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1rem; color: white;
    }
    .li-name { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 0.85rem; color: white; line-height: 1.3; }
    .li-role { font-size: 0.7rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.08em; }
    .flag-bar-side { display: flex; height: 3px; margin-top: 16px; border-radius: 2px; overflow: hidden; }
    .flag-bar-side span { flex: 1; }
    .sidebar-nav { padding: 16px 0; flex: 1; }
    .nav-section-label { font-size: 0.65rem; font-weight: 700; color: rgba(255,255,255,0.3); text-transform: uppercase; letter-spacing: 0.15em; padding: 16px 24px 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 11px 24px; cursor: pointer; font-size: 0.88rem; color: rgba(255,255,255,0.65); transition: all 0.2s; border-left: 3px solid transparent; text-decoration: none; }
    .nav-item:hover { background: rgba(255,255,255,0.07); color: white; }
    .nav-item.active { background: rgba(2,136,209,0.2); color: white; border-left-color: var(--secondary); }
    .ni-icon { font-size: 1rem; width: 20px; text-align: center; }
    .ni-badge { margin-left: auto; background: var(--secondary); color: white; font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border-radius: 100px; }
    .sidebar-footer { padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.08); }
    .user-row { display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--secondary)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; color: white; }
    .u-name { font-size: 0.85rem; font-weight: 600; color: white; }
    .u-role { font-size: 0.7rem; color: rgba(255,255,255,0.45); }
    .btn-logout { margin-left: auto; background: rgba(229,57,53,0.15); border: 1px solid rgba(229,57,53,0.3); color: #ef9a9a; border-radius: 6px; padding: 5px 10px; font-size: 0.75rem; cursor: pointer; }
    .main { margin-left: var(--sidebar-w); min-height: 100vh; }
    .topbar { background: white; padding: 16px 32px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 12px rgba(0,0,0,0.05); }
    .topbar-title { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1.1rem; color: var(--primary); }
    .topbar-right { display: flex; gap: 12px; align-items: center; }
    .topbar-date { font-size: 0.78rem; color: var(--text-light); }
    .btn-view-site { background: var(--primary); color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-size: 0.8rem; font-weight: 600; }
    .content { padding: 32px; }
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
    .stat-card { background: white; border-radius: 14px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); border-left: 4px solid transparent; }
    .stat-card.c-blue { border-color: var(--secondary); }
    .stat-card.c-green { border-color: var(--accent); }
    .stat-card.c-orange { border-color: var(--warning); }
    .stat-card.c-purple { border-color: #7b1fa2; }
    .stat-icon { font-size: 2rem; margin-bottom: 12px; display: block; }
    .stat-value { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 2rem; color: var(--primary); }
    .stat-label { font-size: 0.8rem; color: var(--text-light); margin-top: 4px; }
    .section { display: none; }
    .section.active { display: block; }
    .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .section-header h2 { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 1.4rem; color: var(--primary); }
    .btn-add { background: var(--secondary); color: white; padding: 10px 20px; border-radius: 8px; border: none; font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 0.85rem; cursor: pointer; }
    .table-card { background: white; border-radius: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); overflow: hidden; }
    .table-search { padding: 16px 20px; border-bottom: 1px solid var(--border); }
    .table-search input { width: 100%; padding: 8px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.88rem; outline: none; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: var(--light); }
    thead th { padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; }
    tbody tr { border-top: 1px solid var(--border); }
    tbody tr:hover { background: #f8faff; }
    tbody td { padding: 14px 16px; font-size: 0.88rem; vertical-align: middle; }
    .badge { padding: 3px 10px; border-radius: 100px; font-size: 0.72rem; font-weight: 700; }
    .badge-green { background: #e8f5e9; color: #388e3c; }
    .badge-blue { background: #e3f2fd; color: #0277bd; }
    .badge-orange { background: #fff3e0; color: #e65100; }
    .badge-gray { background: #f5f5f5; color: #616161; }
    .action-btns { display: flex; gap: 6px; }
    .btn-edit, .btn-del { padding: 5px 12px; border-radius: 6px; font-size: 0.78rem; font-weight: 600; cursor: pointer; border: none; }
    .btn-edit { background: #e3f2fd; color: #0277bd; }
    .btn-del { background: #ffebee; color: var(--danger); }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: white; border-radius: 16px; width: 100%; max-width: 580px; max-height: 90vh; overflow-y: auto; box-shadow: 0 32px 80px rgba(0,0,0,0.3); }
    .modal-header { padding: 24px 28px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-header h3 { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1.1rem; color: var(--primary); }
    .modal-close { width: 32px; height: 32px; border-radius: 8px; background: var(--light); border: none; cursor: pointer; font-size: 1rem; }
    .modal-body { padding: 24px 28px; }
    .form-field { margin-bottom: 20px; }
    .form-field label { display: block; font-size: 0.78rem; font-weight: 700; color: var(--text); margin-bottom: 7px; text-transform: uppercase; font-family: 'Montserrat', sans-serif; }
    .form-field input, .form-field select, .form-field textarea { width: 100%; padding: 11px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 0.9rem; color: var(--text); outline: none; background: var(--light); }
    .form-field textarea { resize: vertical; min-height: 90px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .modal-footer { padding: 16px 28px 24px; display: flex; gap: 12px; justify-content: flex-end; }
    .btn-cancel { padding: 10px 24px; border-radius: 8px; border: 2px solid var(--border); background: white; font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 0.88rem; cursor: pointer; color: var(--text-light); }
    .btn-save { padding: 10px 28px; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 0.88rem; cursor: pointer; }
    .toast { position: fixed; bottom: 28px; right: 28px; z-index: 9999; background: var(--success); color: white; padding: 14px 20px; border-radius: 10px; font-size: 0.88rem; font-weight: 600; display: flex; align-items: center; gap: 10px; transform: translateY(80px); opacity: 0; transition: all 0.3s; pointer-events: none; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.error { background: var(--danger); }
    .loading { text-align: center; padding: 40px; color: var(--text-light); }
    .spinner { display: inline-block; width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--secondary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .db-badge { background: #e8f5e9; color: #388e3c; padding: 4px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 700; }
  </style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-row">
      <div class="logo-badge">CRS</div>
      <div>
        <div class="li-name">Conseil R√©gional<br>du Sud</div>
        <div class="li-role">Administration</div>
      </div>
    </div>
    <div class="flag-bar-side">
      <span style="background:#007A5E"></span>
      <span style="background:#CE1126"></span>
      <span style="background:#FCD116"></span>
    </div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Tableau de bord</div>
    <a class="nav-item active" onclick="showSection('dashboard',this)">
      <span class="ni-icon">üìä</span> Vue d'ensemble
    </a>
    <div class="nav-section-label">Contenu</div>
    <a class="nav-item" onclick="showSection('actualites',this)">
      <span class="ni-icon">üì∞</span> Actualit√©s
      <span class="ni-badge" id="badge-actu">0</span>
    </a>
    <a class="nav-item" onclick="showSection('publications',this)">
      <span class="ni-icon">üìÑ</span> Publications
      <span class="ni-badge" id="badge-pub">0</span>
    </a>
    <a class="nav-item" onclick="showSection('projets',this)">
      <span class="ni-icon">üèóÔ∏è</span> Projets
    </a>
    <div class="nav-section-label">Site</div>
    <a class="nav-item" onclick="showSection('parametres',this)">
      <span class="ni-icon">‚öôÔ∏è</span> Param√®tres
    </a>
  </nav>
  <div class="sidebar-footer">
    <div class="user-row">
      <div class="user-avatar">A</div>
      <div>
        <div class="u-name">Administrateur</div>
        <div class="u-role">Super Admin</div>
      </div>
      <button class="btn-logout" onclick="logout()">D√©co.</button>
    </div>
  </div>
</div>

<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="pageTitle">Vue d'ensemble</div>
    <div class="topbar-right">
      <span class="db-badge">üü¢ Neon connect√©</span>
      <span class="topbar-date" id="currentDate"></span>
      <a href="../index.html" target="_blank" class="btn-view-site">üåê Voir le site</a>
    </div>
  </div>

  <div class="content">

    <!-- DASHBOARD -->
    <div class="section active" id="sec-dashboard">
      <div class="stats-grid">
        <div class="stat-card c-blue">
          <span class="stat-icon">üì∞</span>
          <div class="stat-value" id="count-actu">‚Äî</div>
          <div class="stat-label">Actualit√©s publi√©es</div>
        </div>
        <div class="stat-card c-green">
          <span class="stat-icon">üìÑ</span>
          <div class="stat-value" id="count-pub">‚Äî</div>
          <div class="stat-label">Publications</div>
        </div>
        <div class="stat-card c-orange">
          <span class="stat-icon">üèóÔ∏è</span>
          <div class="stat-value" id="count-proj">‚Äî</div>
          <div class="stat-label">Projets</div>
        </div>
        <div class="stat-card c-purple">
          <span class="stat-icon">üóÑÔ∏è</span>
          <div class="stat-value" style="font-size:1rem;margin-top:8px;">Neon</div>
          <div class="stat-label">Base de donn√©es active</div>
        </div>
      </div>
      <div class="table-card">
        <div style="padding:20px;font-family:'Montserrat',sans-serif;font-weight:700;color:var(--primary);">
          Derni√®res actualit√©s
        </div>
        <table>
          <thead><tr><th>Titre</th><th>Cat√©gorie</th><th>Date</th><th>Statut</th></tr></thead>
          <tbody id="dash-actu-body">
            <tr><td colspan="4" class="loading"><div class="spinner"></div><br>Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ACTUALIT√âS -->
    <div class="section" id="sec-actualites">
      <div class="section-header">
        <h2>üì∞ Gestion des Actualit√©s</h2>
        <button class="btn-add" onclick="openModal('actu')">Ôºã Nouvelle actualit√©</button>
      </div>
      <div class="table-card">
        <div class="table-search">
          <input type="text" placeholder="üîç Rechercher..." oninput="filterTable(this,'actu-body')">
        </div>
        <table>
          <thead><tr><th>Titre</th><th>Cat√©gorie</th><th>Date</th><th>Statut</th><th>Actions</th></tr></thead>
          <tbody id="actu-body">
            <tr><td colspan="5" class="loading"><div class="spinner"></div><br>Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PUBLICATIONS -->
    <div class="section" id="sec-publications">
      <div class="section-header">
        <h2>üìÑ Publications officielles</h2>
        <button class="btn-add" onclick="openModal('pub')">Ôºã Nouvelle publication</button>
      </div>
      <div class="table-card">
        <div class="table-search">
          <input type="text" placeholder="üîç Rechercher..." oninput="filterTable(this,'pub-body')">
        </div>
        <table>
          <thead><tr><th>Titre</th><th>Type</th><th>Date</th><th>Actions</th></tr></thead>
          <tbody id="pub-body">
            <tr><td colspan="4" class="loading"><div class="spinner"></div><br>Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PROJETS -->
    <div class="section" id="sec-projets">
      <div class="section-header">
        <h2>üèóÔ∏è Gestion des Projets</h2>
        <button class="btn-add" onclick="openModal('proj')">Ôºã Nouveau projet</button>
      </div>
      <div class="table-card">
        <table>
          <thead><tr><th>Nom du projet</th><th>Budget</th><th>Avancement</th><th>Statut</th><th>Actions</th></tr></thead>
          <tbody id="proj-body">
            <tr><td colspan="5" class="loading"><div class="spinner"></div><br>Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PARAM√àTRES -->
    <div class="section" id="sec-parametres">
      <h2 style="font-family:'Montserrat',sans-serif;font-weight:800;color:var(--primary);margin-bottom:24px;">‚öôÔ∏è Param√®tres</h2>
      <div class="table-card" style="padding:24px;max-width:500px;">
        <div class="form-field">
          <label>Email de contact</label>
          <input type="email" value="contact@conseilregionalsud.cm">
        </div>
        <div class="form-field">
          <label>T√©l√©phone</label>
          <input type="text" value="(+237) 222 28 44 40">
        </div>
        <div class="form-field">
          <label>Facebook</label>
          <input type="url" value="https://www.facebook.com/share/18ckuwk695/">
        </div>
        <button class="btn-save" onclick="showToast('Param√®tres sauvegard√©s ‚úì')">üíæ Sauvegarder</button>
      </div>
    </div>

  </div>
</div>

<!-- Modal Actualit√© -->
<div class="modal-overlay" id="modal-actu">
  <div class="modal">
    <div class="modal-header">
      <h3>üì∞ Nouvelle actualit√©</h3>
      <button class="modal-close" onclick="closeModal('actu')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-field">
          <label>Date</label>
          <input type="date" id="actu-date">
        </div>
        <div class="form-field">
          <label>Cat√©gorie</label>
          <select id="actu-cat">
            <option>Gouvernance</option>
            <option>Infrastructures</option>
            <option>Mines & Industrie</option>
            <option>√ânergie</option>
            <option>Agriculture</option>
            <option>Sant√©</option>
            <option>Environnement</option>
            <option>Partenariats</option>
          </select>
        </div>
      </div>
      <div class="form-field">
        <label>Titre</label>
        <input type="text" id="actu-title" placeholder="Titre de l'actualit√©">
      </div>
      <div class="form-field">
        <label>R√©sum√©</label>
        <textarea id="actu-resume" placeholder="D√©crivez bri√®vement..."></textarea>
      </div>
      <div class="form-field">
        <label>Statut</label>
        <select id="actu-status">
          <option value="Publi√©">‚úÖ Publi√©</option>
          <option value="Brouillon">üìù Brouillon</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('actu')">Annuler</button>
      <button class="btn-save" onclick="saveActu()">üíæ Publier</button>
    </div>
  </div>
</div>

<!-- Modal Publication -->
<div class="modal-overlay" id="modal-pub">
  <div class="modal">
    <div class="modal-header">
      <h3>üìÑ Nouvelle publication</h3>
      <button class="modal-close" onclick="closeModal('pub')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-field">
          <label>Date</label>
          <input type="date" id="pub-date">
        </div>
        <div class="form-field">
          <label>Type</label>
          <select id="pub-type">
            <option>D√©lib√©ration</option>
            <option>Rapport d'activit√©</option>
            <option>Budget</option>
            <option>Communiqu√© officiel</option>
            <option>Appel d'offres</option>
          </select>
        </div>
      </div>
      <div class="form-field">
        <label>Titre</label>
        <input type="text" id="pub-title" placeholder="Titre de la publication">
      </div>
      <div class="form-field">
        <label>Description</label>
        <textarea id="pub-desc" placeholder="Description courte..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('pub')">Annuler</button>
      <button class="btn-save" onclick="savePub()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- Modal Projet -->
<div class="modal-overlay" id="modal-proj">
  <div class="modal">
    <div class="modal-header">
      <h3>üèóÔ∏è Nouveau projet</h3>
      <button class="modal-close" onclick="closeModal('proj')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-field">
        <label>Nom du projet</label>
        <input type="text" id="proj-name" placeholder="Nom du projet">
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>Budget (FCFA)</label>
          <input type="text" id="proj-budget" placeholder="Ex: 150 000 000">
        </div>
        <div class="form-field">
          <label>Avancement (%)</label>
          <input type="number" id="proj-progress" min="0" max="100" placeholder="0 √† 100">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>Commune</label>
          <input type="text" id="proj-commune" placeholder="Ex: Kribi 1er">
        </div>
        <div class="form-field">
          <label>Statut</label>
          <select id="proj-status">
            <option>En cours</option>
            <option>Achev√©</option>
            <option>Planifi√©</option>
            <option>Suspendu</option>
          </select>
        </div>
      </div>
      <div class="form-field">
        <label>Description</label>
        <textarea id="proj-desc" placeholder="Description du projet..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('proj')">Annuler</button>
      <button class="btn-save" onclick="saveProj()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">‚úÖ <span id="toast-msg">Sauvegard√©</span></div>

<script>
// Protection connexion
if (sessionStorage.getItem('crs_admin') !== 'true') {
  window.location.href = 'index.html';
}

// Date
document.getElementById('currentDate').textContent =
  new Date().toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
document.querySelectorAll('input[type=date]').forEach(el => {
  el.value = new Date().toISOString().split('T')[0];
});

// ===== APPELS API NEON =====
async function apiGet(endpoint) {
  const r = await fetch(`/.netlify/functions/${endpoint}`);
  return r.json();
}
async function apiPost(endpoint, body) {
  const r = await fetch(`/.netlify/functions/${endpoint}`, {
    method: 'POST',
    body: JSON.stringify(body)
  });
  return r.json();
}
async function apiDelete(endpoint, id) {
  const r = await fetch(`/.netlify/functions/${endpoint}`, {
    method: 'DELETE',
    body: JSON.stringify({ id })
  });
  return r.json();
}

// ===== BADGES =====
function catBadge(cat) {
  const map = { 'Gouvernance':'badge-blue','Infrastructures':'badge-green','Mines & Industrie':'badge-orange','√ânergie':'badge-orange','Agriculture':'badge-green','Partenariats':'badge-blue' };
  return `<span class="badge ${map[cat]||'badge-gray'}">${cat}</span>`;
}
function statusBadge(s) {
  return s==='Publi√©'||s==='Achev√©' ? `<span class="badge badge-green">${s}</span>`
       : s==='En cours'             ? `<span class="badge badge-blue">${s}</span>`
       : s==='Planifi√©'             ? `<span class="badge badge-orange">${s}</span>`
       :                              `<span class="badge badge-gray">${s}</span>`;
}

// ===== CHARGER ACTUALIT√âS =====
async function loadActu() {
  const res = await apiGet('actualites');
  const data = res.data || [];
  document.getElementById('count-actu').textContent = data.length;
  document.getElementById('badge-actu').textContent = data.length;
  const html = data.map(a => `<tr>
    <td><strong>${a.titre}</strong></td>
    <td>${catBadge(a.categorie)}</td>
    <td>${a.date_pub||''}</td>
    <td>${statusBadge(a.statut)}</td>
    <td><div class="action-btns">
      <button class="btn-del" onclick="delActu(${a.id})">üóë Suppr.</button>
    </div></td>
  </tr>`).join('');
  document.getElementById('actu-body').innerHTML = html || '<tr><td colspan="5" style="text-align:center;padding:24px;color:#aaa;">Aucune actualit√©</td></tr>';
  document.getElementById('dash-actu-body').innerHTML = data.slice(0,4).map(a=>`<tr>
    <td>${a.titre}</td><td>${catBadge(a.categorie)}</td><td>${a.date_pub||''}</td><td>${statusBadge(a.statut)}</td>
  </tr>`).join('') || '<tr><td colspan="4" style="text-align:center;padding:24px;color:#aaa;">Aucune actualit√©</td></tr>';
}

// ===== CHARGER PUBLICATIONS =====
async function loadPub() {
  const res = await apiGet('publications');
  const data = res.data || [];
  document.getElementById('count-pub').textContent = data.length;
  document.getElementById('badge-pub').textContent = data.length;
  const html = data.map(p => `<tr>
    <td><strong>${p.titre}</strong></td>
    <td>${catBadge(p.type_pub)}</td>
    <td>${p.date_pub||''}</td>
    <td><div class="action-btns">
      <button class="btn-del" onclick="delPub(${p.id})">üóë Suppr.</button>
    </div></td>
  </tr>`).join('');
  document.getElementById('pub-body').innerHTML = html || '<tr><td colspan="4" style="text-align:center;padding:24px;color:#aaa;">Aucune publication</td></tr>';
}

// ===== CHARGER PROJETS =====
async function loadProj() {
  const res = await apiGet('projets');
  const data = res.data || [];
  document.getElementById('count-proj').textContent = data.length;
  const html = data.map(p => `<tr>
    <td><strong>${p.nom}</strong><br><small style="color:var(--text-light)">${p.commune||''}</small></td>
    <td>${p.budget||'ND'}</td>
    <td>
      <div style="background:#eee;border-radius:4px;height:8px;width:120px;overflow:hidden;">
        <div style="height:100%;width:${p.avancement||0}%;background:linear-gradient(90deg,var(--secondary),var(--accent));border-radius:4px;"></div>
      </div>
      <small>${p.avancement||0}%</small>
    </td>
    <td>${statusBadge(p.statut)}</td>
    <td><div class="action-btns">
      <button class="btn-del" onclick="delProj(${p.id})">üóë Suppr.</button>
    </div></td>
  </tr>`).join('');
  document.getElementById('proj-body').innerHTML = html || '<tr><td colspan="5" style="text-align:center;padding:24px;color:#aaa;">Aucun projet</td></tr>';
}

// ===== SAUVEGARDER =====
async function saveActu() {
  const titre = document.getElementById('actu-title').value.trim();
  if (!titre) { alert('Veuillez saisir un titre.'); return; }
  const res = await apiPost('actualites', {
    titre,
    categorie: document.getElementById('actu-cat').value,
    date_pub: document.getElementById('actu-date').value,
    statut: document.getElementById('actu-status').value,
    resume: document.getElementById('actu-resume').value,
  });
  if (res.success) {
    closeModal('actu');
    showToast('Actualit√© publi√©e avec succ√®s ‚úì');
    document.getElementById('actu-title').value = '';
    document.getElementById('actu-resume').value = '';
    loadActu();
  } else {
    showToast('Erreur : ' + res.error, true);
  }
}

async function savePub() {
  const titre = document.getElementById('pub-title').value.trim();
  if (!titre) { alert('Veuillez saisir un titre.'); return; }
  const res = await apiPost('publications', {
    titre,
    type_pub: document.getElementById('pub-type').value,
    date_pub: document.getElementById('pub-date').value,
    description: document.getElementById('pub-desc').value,
    fichier: '',
  });
  if (res.success) {
    closeModal('pub');
    showToast('Publication enregistr√©e ‚úì');
    document.getElementById('pub-title').value = '';
    loadPub();
  } else {
    showToast('Erreur : ' + res.error, true);
  }
}

async function saveProj() {
  const nom = document.getElementById('proj-name').value.trim();
  if (!nom) { alert('Veuillez saisir un nom.'); return; }
  const res = await apiPost('projets', {
    nom,
    budget: document.getElementById('proj-budget').value,
    avancement: parseInt(document.getElementById('proj-progress').value)||0,
    commune: document.getElementById('proj-commune').value,
    statut: document.getElementById('proj-status').value,
    description: document.getElementById('proj-desc').value,
  });
  if (res.success) {
    closeModal('proj');
    showToast('Projet enregistr√© ‚úì');
    document.getElementById('proj-name').value = '';
    loadProj();
  } else {
    showToast('Erreur : ' + res.error, true);
  }
}

// ===== SUPPRIMER =====
async function delActu(id) {
  if (!confirm('Supprimer cette actualit√© ?')) return;
  await apiDelete('actualites', id);
  showToast('Supprim√©', true);
  loadActu();
}
async function delPub(id) {
  if (!confirm('Supprimer cette publication ?')) return;
  await apiDelete('publications', id);
  showToast('Supprim√©', true);
  loadPub();
}
async function delProj(id) {
  if (!confirm('Supprimer ce projet ?')) return;
  await apiDelete('projets', id);
  showToast('Supprim√©', true);
  loadProj();
}

// ===== MODAL =====
function openModal(name) { document.getElementById('modal-'+name).classList.add('open'); }
function closeModal(name) { document.getElementById('modal-'+name).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
});

// ===== NAVIGATION =====
const titles = { dashboard:"Vue d'ensemble", actualites:"Actualit√©s", publications:"Publications", projets:"Projets", parametres:"Param√®tres" };
function showSection(name, el) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  document.getElementById('pageTitle').textContent = titles[name]||name;
  if(el) el.classList.add('active');
}

function filterTable(input, tbodyId) {
  const q = input.value.toLowerCase();
  document.querySelectorAll('#'+tbodyId+' tr').forEach(tr => {
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

function showToast(msg, isError) {
  const t = document.getElementById('toast');
  document.getElementById('toast-msg').textContent = msg;
  t.className = 'toast' + (isError?' error':'') + ' show';
  setTimeout(() => t.className = 'toast'+(isError?' error':''), 3000);
}

function logout() {
  if (confirm('Se d√©connecter ?')) {
    sessionStorage.removeItem('crs_admin');
    window.location.href = 'index.html';
  }
}

// ===== INITIALISATION =====
loadActu();
loadPub();
loadProj();
</script>
</body>
</html>
